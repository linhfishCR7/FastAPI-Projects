## JWT Authentication + GraphQL (Strawberry) Example â€” Updated

This folder is a demonstration of a FastAPI + Strawberry GraphQL app backed by SQLite (SQLAlchemy) that uses JWT authentication. The README reflects recent structural changes (lifespan startup, config via `.env`, central auth via `context_getter` and Strawberry permissions).

What this version includes
- `register` and `login` GraphQL mutations (in `schema.py`).
- `auth.py` helpers to create/verify tokens and an `IsAuthenticated` permission class used on protected fields.
- `config.py` that reads `.env` (via `python-dotenv` if installed) and exposes `SECRET_KEY`, `ALGORITHM`, and `ACCESS_TOKEN_EXPIRE_MINUTES`.
- `main.py` uses a `lifespan` async context manager to create DB tables on startup and a `context_getter` to set `info.context['current_user']` from the Bearer token.

Quick setup

- Recommended Python version: `3.12` (this project was developed with 3.12).
- Install runtime dependencies in the `env` venv (example):

```bash
python -m pip install PyJWT python-dotenv
# optional for secure password storage:
python -m pip install passlib[bcrypt]
```

Configuration (`.env`)

Create a `.env` file inside `5. JWT Authentication/` with:

```
SECRET_KEY=your-very-secret-key
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=60
```

`config.py` will load this file (if `python-dotenv` is installed) or read the values from environment variables.

Run the app

Start the server from the `5. JWT Authentication` folder:

```bash
cd '/Users/rajansahu/Desktop/Study/FastAPI/GraphSQL/5. JWT Authentication'
uvicorn main:app --reload
```

GraphQL endpoint

Open the GraphQL UI at `http://127.0.0.1:8000/graphql`.

Core flows

- Register a user:

```graphql
mutation {
  register(username: "alice", password: "secret") {
    id
    username
  }
}
```

- Login and receive a JWT:

```graphql
mutation {
  login(username: "alice", password: "secret") {
    accessToken
    tokenType
  }
}
```

- Use the JWT for protected fields:

Add header: `Authorization: Bearer <accessToken>`

Example protected mutation (requires auth):

```graphql
mutation {
  createBook(title: "My Book", author: "Me") {
    id
    title
    author
  }
}
```

Notes about how auth is applied
- `main.py` uses `context_getter` to extract the Bearer token and populate `info.context['current_user']`.
- `schema.py` marks protected fields with `permission_classes=[IsAuthenticated]`. The `IsAuthenticated` class checks `info.context['current_user']`.
- This combination centralizes authentication logic (you only need to mark fields with the permission class).

Troubleshooting
- If a query/mutation returns `Authentication required`:
  - Ensure your request includes the `Authorization: Bearer <token>` header.
  - Tokens must be generated by this app (the same `SECRET_KEY` and `ALGORITHM`). Use the `login` mutation to get a fresh token.
  - Confirm `.env` is present in the working directory used to run uvicorn (or that environment variables are set).
  - Restart the server after changing `.env`.

- To inspect a token's `exp` claim (dev only): decode the JWT with the same secret:

```python
import jwt
payload = jwt.decode('<token>', 'your-very-secret-key', algorithms=['HS256'])
print(payload)
```

Development notes and next steps
- Passwords are stored in plain text for the demo. For production, install `passlib[bcrypt]` and update `register`/`authenticate_user` to hash/verify passwords.
- Replace the secret with a secure value and keep it out of version control (use environment variables or a secrets manager).
- If you want a REST `/login` endpoint for non-GraphQL clients, I can add it quickly to `main.py`.

If you want, I can update this README with examples of curl requests and VS Code debug instructions. What would you like added?
## JWT Authentication + GraphQL (Strawberry) Example

This folder demonstrates a small FastAPI + Strawberry GraphQL app backed by SQLite (SQLAlchemy) with JWT-based authentication.

What you'll find
- GraphQL schema with `register` and `login` mutations plus CRUD for `Book`.
- `auth.py` with simple JWT helpers (create/verify token).
- `main.py` wiring a `context_getter` so resolvers can access `info.context['current_user']`.

Requirements
- Python 3.12
- The virtualenv in this repo already contains many packages, but you may need to install `PyJWT` and optionally `passlib[bcrypt]`:

```bash
python -m pip install PyJWT
# optional (for password hashing):
python -m pip install passlib[bcrypt]
```

Run the app

Start the server from this folder:

```bash
cd '/Users/rajansahu/Desktop/Study/FastAPI/GraphSQL/5. JWT Authentication'
uvicorn main:app --reload
```

Open the GraphQL UI at `http://127.0.0.1:8000/graphql`.

GraphQL usage examples

1) Register a user (GraphQL mutation):

```graphql
mutation {
  register(username: "alice", password: "secret") {
    id
    username
  }
}
```

2) Login to receive a JWT:

```graphql
mutation {
  login(username: "alice", password: "secret") {
    accessToken
    tokenType
  }
}
```

3) Use the returned token in the HTTP `Authorization` header for protected mutations/queries:

Header:
```
Authorization: Bearer <accessToken>
```

Protected example (create book requires authentication):

```graphql
mutation {
  createBook(title: "My Book", author: "Me") {
    id
    title
    author
  }
}
```

Security notes (important)
- The example stores passwords in plain text for simplicity. In any real app, hash passwords using `passlib`/`bcrypt`.
- Replace the hard-coded `SECRET_KEY` in `auth.py` with a strong secret loaded from environment variables or a secrets manager.
- Consider token expiry, refresh tokens, and revocation strategies for production.

